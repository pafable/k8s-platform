final String agentLabel = 'jenkins-agent'
final String jenkinsParamName = 'JENKINS_AGENT_TAG'
final String platformBranch = 'refs/heads/master'
final String platformRepo = 'https://github.com/pafable/k8s-platform.git'
final String discordBotRepo = 'https://github.com/pafable/discord-bot-3'
final String discordBotBranch = 'refs/heads/main' // change this once PR is merged for discord-bot-3

// job descriptions
final String appsDesc = 'Apps deployer'
final String dnsDesc = 'DNS updater'
final String discordBotDesc = 'Discord bot builder'
final String jenkinsDesc = 'Jenkins agent builder'
final String jenkinsParamDesc = 'Tag for Jenkins agent'
final String k3sInfraDesc = 'Builds k3s infra'
final String packyDesc = 'Builds images'
final String rpmDesc = 'Builds rpm server infra'

final def jobsToScripts = [
    'agent-builder': 'cicd/agent-builder/Jenkinsfile',
    'apps-deployer': 'cicd/apps/Jenkinsfile',
    'discord-bot-builder': 'cicd/builder/Jenkinsfile',
    'dns-updater': 'cicd/dns/Jenkinsfile',
    'k3s-infra-factory': 'cicd/k3s/Jenkinsfile',
    'packy': 'cicd/packy/Jenkinsfile',
    'rpm-server': 'cicd/rpm-srv/Jenkinsfile'
]

pipeline {
    agent {
      label "${agentLabel}"
    }

    options {
        ansiColor('xterm')
        timeout(
            time: 5,
            unit: 'MINUTES'
        )
    }

    stages {
        stage('seeding') {
            steps {
                script {
                    jobsToScripts.each {
                        final job, final path ->
                            if (job == 'discord-bot-builder') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${discordBotDesc}")
                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${discordBotRepo}")
                                                        }
                                                        branch("${discordBotBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }
                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }

                            if (job == 'agent-builder') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${jenkinsDesc}")
                                        parameters {
                                            stringParam {
                                                description("${jenkinsParamDesc}")
                                                name("${jenkinsParamName}")
                                                trim(true)
                                            }
                                        }
                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${platformRepo}")
                                                        }
                                                        branch("${platformBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }
                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }

                            if (job == 'apps-deployer') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${appsDesc}")
                                        parameters {
                                            choiceParam(
                                                'ACTIONS',
                                                [
                                                    'create',
                                                    'destroy'
                                                ],
                                                'Create or destroy'
                                            )
                                        }
                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${platformRepo}")
                                                        }
                                                        branch("${platformBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }
                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }

                            if (job == 'dns-updater') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${dnsDesc}")
                                        parameters {
                                            choiceParam(
                                                'ACTIONS',
                                                [
                                                    'create',
                                                    'destroy'
                                                ],
                                                'Create or destroy'
                                            )
                                        }
                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${platformRepo}")
                                                        }
                                                        branch("${platformBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }
                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }

                            if (job == 'k3s-infra-factory') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${k3sInfraDesc}")
                                        parameters {
                                            choiceParam(
                                                'ACTIONS',
                                                [
                                                    'create',
                                                    'destroy'
                                                ],
                                                'Create or destroy'
                                            )
                                        }
                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${platformRepo}")
                                                        }
                                                        branch("${platformBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }
                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }

                            if (job == 'packy') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${packyDesc}")
                                        parameters {
                                            choiceParam(
                                                'DISTRO',
                                                [
                                                    'debian',
                                                    'oracle',
                                                    'rocky',
                                                    'ubuntu'
                                                ],
                                                'linux distribution'
                                            )

                                            choiceParam(
                                                'ISO_NAME',
                                                [
                                                    'OracleLinux-R9-U4-x86_64-boot.iso',
                                                    'Rocky-9.4-x86_64-boot.iso',
                                                    'debian-12.7.0-amd64-netinst.iso',
                                                    'ubuntu-24.04.1-live-server-amd64.iso'
                                                ],
                                                'iso names'
                                            )

                                            choiceParam(
                                                'PROXMOX_NODE',
                                                [
                                                    'behemoth',
                                                    'kraken',
                                                    'leviathan'
                                                ],
                                                'proxmox nodes'
                                            )

                                            stringParam(
                                                'TEMPLATE_NAME',
                                                null,
                                                'template name'
                                            )
                                        }
                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${platformRepo}")
                                                        }
                                                        branch("${platformBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }
                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }

                            if (job == 'rpm-server') {
                                jobDsl removedConfigFilesAction: 'DELETE',
                                removedJobAction: 'DELETE',
                                removedViewAction: 'DELETE',
                                scriptText: """
                                    pipelineJob("${job}") {
                                        description("${rpmDesc}")
                                        parameters {
                                            choiceParam(
                                                'ACTIONS',
                                                [
                                                    'create',
                                                    'destroy'
                                                ],
                                                'Create or destroy'
                                            )
                                        }

                                        definition {
                                            cpsScm {
                                                scm {
                                                    git {
                                                        remote {
                                                            url("${platformRepo}")
                                                        }
                                                        branch("${platformBranch}")
                                                    }
                                                }
                                                scriptPath("${path}")
                                                lightweight()
                                            }
                                        }

                                        properties {
                                            disableConcurrentBuilds()
                                            disableResume()
                                        }
                                    }
                                """
                            }
                    }
                }
            }
        }
    }
}