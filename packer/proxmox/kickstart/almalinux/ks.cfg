# Generated by Anaconda 34.25.5.9
# Generated by pykickstart v3.32
#version=RHEL9
# Use graphical install
graphical

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

# Use Alma Linux dnf server repositories as installation source
repo --name="AppStream" --baseurl="http://lunchbox.home.pafable.com:8081/repository/rpm-repo/$releasever/AppStream/$basearch/os/"
repo --name="BaseOS" --baseurl="http://lunchbox.home.pafable.com:8081/repository/rpm-repo/$releasever/BaseOS/$basearch/os/"
repo --name="Epel" --baseurl="http://lunchbox.home.pafable.com:8081/repository/rpm-repo/$releasever/Everything/$basearch/"
repo --name="Extras" --baseurl="http://lunchbox.home.pafable.com:8081/repository/rpm-repo/$releasever/extras/$basearch/os/"
url --url="http://lunchbox.home.pafable.com:8081/repository/rpm-repo/$releasever/BaseOS/$basearch/os/"

# Keyboard layouts
keyboard --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=ens18 --ipv6=auto --activate

%packages
@^server-product-environment
cloud-init
cloud-utils-growpart
coreutils
epel-release
fail2ban
gcc
git
python3.12
qemu-guest-agent
tmux

%end

# Run the Setup Agent on first boot
firstboot --enable

# Generated using Blivet version 3.6.0
ignoredisk --only-use=sda
autopart
# Partition clearing information
clearpart --none --initlabel

# System timezone
timezone America/New_York --utc

#Root password
rootpw --lock
user --groups=wheel --name=deployer --password=$6$lKCF2G/CNefSSTn1$r.d660YSsAnqcuop4OsNEf90NXXqTmGlm9X6dUKad.SraYYrF1mnmiPChjl9VkjERbATDGbUpp61tbEMJGt1z1 --iscrypted --gecos="deployer"
sshkey --username=deployer "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKInEvjrLvKOxo7WC17pv2NfhnwnkiPHVvo3IwIBJwCV deployer"

%post
echo "deployer ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers.d/deployer
chmod 0400 /etc/sudoers.d/deployer

# Disable password authentication in SSH. THIS IS DISABLED FOR NOW BECAUSE PROXMOX DOES NOT SUPPORT SSH KEY AUTH WHEN CREATING IMAGES
#sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
#sed -i 's/#ChallengeResponseAuthentication yes/ChallengeResponseAuthentication no/' /etc/ssh/sshd_config
#sed -i 's/#PubkeyAuthentication yes/PubkeyAuthentication yes/' /etc/ssh/sshd_config
%end

reboot